library(mongolite)
conn <- mongo(collection = 'guba', db = 'guba', url = "mongodb://localhost:27017")
iter <- conn$iterate(query = '{}', field = '{"_id":0, "post_id":1, "reply":1}')

# ????????ȱʧֵ?ĺ???????iter??ȡ֮?󣬿?????ЩԪ????NULL??????NULL??????Ϊrbindlist?????룬??????Ҫ?????ĳɿ?list
# ע?⣬NULL??NA??list() ??????length????0?????????ǲ?ͬ?Ķ??????????漰?? R ?ؼ??? object type????һ??ҪŪ?????????????Ĵ????㿴??��????????????
set_empty_to_na <- function(x, null.as) {
    if (length(x) == 0) { 
        if (is.null(x)) {
            x <- null.as
        }
    } 
    x
}

# ?????? ???? make_post_reply ?????? batch ?棬???????? batch ?治?ȶ???????ֻ???? one()??
#make_post_reply <- function(batch) {
    #lapply(batch, `[[`, "reply") %>% lapply(set_empty_to_na, null.as = list()) %>% lapply(rbindlist, fill = T, use.names = T) %>% rbindlist(use.names = T, fill = T)
#}

make_post_reply <- function(one) {
    # ??one" ????һ?м?¼
    # reply ?ǰ?one??reply??????ȡ??????data.table??
    reply <- one["reply"] %>% lapply(set_empty_to_na, null.as = list()) %>% lapply(rbindlist, fill = T, use.names = T) %>% rbindlist(use.names = T, fill = T)
    # post ?ǰ? one ??post ??????ȡ??????һ????��??
    # ?????? post ֻ??ȡ?? post_id?????????Լ??ģ???ȡ??????��??ֻ??????ʱ??Ҫ??post????һ??data.table
    post <- one$post_id %>% sapply(set_empty_to_na, null.as = NA, USE.NAMES = F)

    # ????post_id ?ǿգ?post_id??˵??ץȡ?????г??ִ????????????ټ??????? ???????ɵ?post??reply ?ϲ??ɳ?һ??data.table
    if (!is.null(post)) {
        if (nrow(reply) == 0) { # ???? reply ?????ڣ???ô???ɵ?dt??ֻ??post
            data.table(post.id = post)
        } else { # ????reply ???ڣ???ô??replyҲ????dt
            data.table(post.id = post, reply)
        }
    } else {# ???? post_id ?գ???ô??????dt??ע?????Ǹ??ؼ????????????? ?? data.table???????? NULL ?? NA???ͻᱨ?���???漰???????Ķ???һ???ԣ??Ǹ??ѵ㡣
        data.table()
    }
}

# ???ж?ȡ
posts <- data.table()
while (!is.null(res <- iter$one())) {
    chunk <- make_post_reply(res)
    posts <- rbindlist(list(chunk, posts), use.names = T, fill = T)
}
r.posts <- fread("posts.csv", fill = T, na.string = "", encoding = "UTF-8")
r.replys <- fread("replys.csv", fill = T, na.string = "", encoding = "UTF-8")
r.posts <- r.posts[postnums != 0]
r.posts[, .N]
r.posts[guba_name == "???Ƹְ?", .N]
r.posts[guba_name == "???Ƹְ?", unique(postnums)]
r.posts[order(create_time), .SD[1], by = .(guba_name)]

late.replys <- r.replys[, .SD[.N], keyby = .(post_id, reply_time)]
r.replys <- r.replys[, reply_content := str_replace_all(reply_content, "<.*?>", "")]

int.data <- r.replys[r.posts, on = .(post_id), nomatch = 0]
int.data <- int.data[!is.na(reply_author)]
int.data.1 <- r.posts[r.replys, ]
    

a <- r.posts[1, 2, 3]
b <- r.posts[1, 1]
c <- r.posts[1]
microbenchmark({
earl.posts <- r.posts[, head(.SD, 1), by = .(guba_name)]
}, times = 100)

microbenchmark({
earl.posts <- r.posts[, .SD[1], by = .(guba_name)]
}, times = 100)

r.posts[order(create_time), tag := sequence(.N), by = .(guba_name)]

